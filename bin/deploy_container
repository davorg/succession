#!/usr/bin/env bash
set -euo pipefail

PROJECT_ID="${PROJECT_ID:-dave-web-apps}"
REGION="${REGION:-europe-west1}"
SERVICE_NAME="${SERVICE_NAME:-succession}"
VPC_CONNECTOR="${VPC_CONNECTOR:-los-connector}"
REPO="${REPO:-containers}"
IMAGE_NAME="${IMAGE_NAME:-succession}"

MEMCACHE_INSTANCE="${MEMCACHE_INSTANCE:-los-cache}"

# SQLite DSN (matches Dockerfile)
SUCC_DSN="${SUCC_DSN:-dbi:SQLite:dbname=/app/data/los.sqlite;mode=ro;immutable=1}"

# --- Resolve Memcached host/port if not provided explicitly ---

if [[ -z "${SUCC_CACHE_SERVER:-}" || -z "${SUCC_CACHE_PORT:-}" ]]; then
  echo "Resolving Memcached endpoint from gcloud memcache describe (${MEMCACHE_INSTANCE})â€¦"

  HOST="$(gcloud memcache instances describe "${MEMCACHE_INSTANCE}" \
    --project="${PROJECT_ID}" \
    --region="${REGION}" \
    --format='value(memcacheNodes[0].host)')"

  PORT="$(gcloud memcache instances describe "${MEMCACHE_INSTANCE}" \
    --project="${PROJECT_ID}" \
    --region="${REGION}" \
    --format='value(memcacheNodes[0].port)')"

  if [[ -z "${HOST}" || -z "${PORT}" ]]; then
    echo "ERROR: Could not resolve Memcached host/port from instance '${MEMCACHE_INSTANCE}'" >&2
    exit 1
  fi

  SUCC_CACHE_SERVER="${SUCC_CACHE_SERVER:-$HOST}"
  SUCC_CACHE_PORT="${SUCC_CACHE_PORT:-$PORT}"

  echo "Using Memcached at ${SUCC_CACHE_SERVER}:${SUCC_CACHE_PORT}"
fi

# --- Image reference: use tag based on commit SHA ---

SHA="${GITHUB_SHA:-$(git rev-parse HEAD)}"
IMAGE_PATH="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE_NAME}"
IMAGE_REF="${IMAGE_PATH}:${SHA}"

echo "Deploying image ${IMAGE_REF}"

ENV_VARS="SUCC_DSN=${SUCC_DSN},SUCC_CACHE_SERVER=${SUCC_CACHE_SERVER},SUCC_CACHE_PORT=${SUCC_CACHE_PORT},PLACK_ENV=production"

gcloud run deploy "${SERVICE_NAME}" \
  --image="${IMAGE_REF}" \
  --project="${PROJECT_ID}" \
  --region="${REGION}" \
  --platform=managed \
  --allow-unauthenticated \
  --vpc-connector="${VPC_CONNECTOR}" \
  --vpc-egress=private-ranges-only \
  --cpu=1 \
  --memory=1Gi \
  --concurrency=40 \
  --min-instances=0 \
  --max-instances=10 \
  --set-env-vars="${ENV_VARS}"

