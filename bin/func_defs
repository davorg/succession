#!/bin/bash
# Common helpers for DB scripts (SQLite or MySQL)

# --- Backend detection -------------------------------------------------------
is_sqlite() {
  if [[ -n "$SUCC_DB_PATH" ]]; then
    return 0
  fi
  if [[ -n "$SUCC_DSN" && "$SUCC_DSN" == dbi:SQLite:* ]]; then
    return 0
  fi
  return 1
}

is_mysql() {
  ! is_sqlite
}

# --- Resolve SQLite db file --------------------------------------------------
sqlite_db_path() {
  if [[ -n "$SUCC_DB_PATH" ]]; then
    printf '%s' "$SUCC_DB_PATH"
    return
  fi
  # Try to extract dbname=... from SUCC_DSN (handles ;mode=ro;â€¦ after it)
  # e.g. dbi:SQLite:dbname=/path/to/los.sqlite;mode=ro;immutable=1
  if [[ -n "$SUCC_DSN" ]]; then
    local dsn="$SUCC_DSN"
    local val
    val="$(printf '%s' "$dsn" | sed -n 's/.*dbname=\([^;]*\).*/\1/p')"
    if [[ -n "$val" ]]; then
      printf '%s' "$val"
      return
    fi
  fi
  return 1
}

# --- Validation --------------------------------------------------------------
check_vars() {
  local -a errors=()

  if is_sqlite; then
    local path
    path="$(sqlite_db_path)" || errors+=("SUCC_DB_PATH or SUCC_DSN(dbname)")
    if [[ -z "$path" || ! -f "$path" ]]; then
      errors+=("sqlite_db_missing:${path:-<empty>}")
    fi
  else
    # MySQL: SUCC_DB_PORT optional
    local vars=(SUCC_DB_HOST SUCC_DB_NAME SUCC_DB_USER SUCC_DB_PASS)
    for var_name in "${vars[@]}"; do
      [[ -z "${!var_name}" ]] && errors+=("$var_name")
    done
  fi

  if (( ${#errors[@]} )); then
    echo "Missing/invalid environment variable(s): ${errors[*]}" >&2
    exit 1
  fi
}

# --- Command wrappers --------------------------------------------------------
db_shell() {
  if is_sqlite; then
    local db; db="$(sqlite_db_path)" || return 1
    command -v sqlite3 >/dev/null || { echo "sqlite3 CLI not found" >&2; return 127; }
    sqlite3 "$db"
  else
    command -v mysql >/dev/null || { echo "mysql CLI not found" >&2; return 127; }
    mysql -h"$SUCC_DB_HOST" -P"${SUCC_DB_PORT:-3306}" -u"$SUCC_DB_USER" -p"$SUCC_DB_PASS" "$SUCC_DB_NAME"
  fi
}

db_exec() {
  # Reads SQL from stdin, executes in the chosen backend
  if is_sqlite; then
    local db; db="$(sqlite_db_path)" || return 1
    command -v sqlite3 >/dev/null || { echo "sqlite3 CLI not found" >&2; return 127; }
    sqlite3 -echo "$db"
  else
    command -v mysql >/dev/null || { echo "mysql CLI not found" >&2; return 127; }
    mysql -t -h"$SUCC_DB_HOST" -P"${SUCC_DB_PORT:-3306}" -u"$SUCC_DB_USER" -p"$SUCC_DB_PASS" "$SUCC_DB_NAME"
  fi
}

