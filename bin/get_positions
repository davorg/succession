#!/usr/bin/perl

use strict;
use warnings;
use feature 'say';

use Succession::App;

my $app = Succession::App->new;
my $sch = $app->model->schema;

foreach ($sch->resultset('ChangeDate')->search(undef, { order_by => 'change_date' })) {
  say $_->change_date;
  $app = Succession::App->new(date => $_->change_date);
  my $succ = $app->succession;
  say scalar @$succ . ' people in the list';

  my $x = 1;
  foreach my $p (@$succ) {
    my $pos = $x;
    say $pos;
    $pos = -1 if $p->excluded_on_date($_->change_date);
    my $prev_pos = $p->position_on_date($_->change_date);

    if ($prev_pos) {
      if ($prev_pos->position != $pos) {
        $prev_pos->update({ end => $_->change_date });
        $p->add_to_positions({
          position => $pos,
          start => $_->change_date,
        });
      }
    } else {
      my $start = $_->change_date;
      $start = undef if $start == $p->born;
      $p->add_to_positions({
        position => $pos,
        start => $start,
      });
    }
    ++$x if $pos != -1;
  }
}
