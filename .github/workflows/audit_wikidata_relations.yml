name: Audit Wikidata Relations

# Run weekly on Monday at 9:00 AM UTC
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

# Ensure only one audit workflow runs at a time to prevent conflicts
concurrency:
  group: audit-wikidata-relations
  cancel-in-progress: false

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUCC_DB_PATH: data/los.sqlite
      SUCC_DUMP_PATH: data/succession_dump.sql
      SUCC_LIB: Succession/lib
    
    steps:
      - name: Check out code
        uses: actions/checkout@v6
      
      - name: Set up perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: 'latest'
      
      - name: Perl version
        run: perl -V
      
#      - name: Setup SQLite database
#        run: bin/load_db
      
      - name: Check database
        run: bin/db "select count(*) from sovereign"
      
      - name: Install modules
        run: cpanm -n --installdeps .
      
      - name: Run audit_wikidata_relations
        continue-on-error: true
        run: |
          echo "Running audit_wikidata_relations with rate limiting..."
          export PERL5LIB=$PERL5LIB:$SUCC_LIB
          # Use conservative limits to avoid rate limiting: 200 requests max, 500ms sleep
          bin/audit_wikidata_relations --apply --verbose --max-requests 200 --sleep-ms 500 > audit_results.csv 2> audit_errors.log
          echo "Audit complete. Results saved."
      
      - name: Display audit summary
        if: always()
        run: |
          echo "=== Audit Errors ==="
          if [ -f audit_errors.log ]; then
            cat audit_errors.log
          else
            echo "No error log found"
          fi
          echo ""
          echo "=== Audit Results (first 50 lines) ==="
          if [ -f audit_results.csv ]; then
            head -n 50 audit_results.csv
            LINE_COUNT=$(wc -l < audit_results.csv)
            echo ""
            echo "Total lines in results: $LINE_COUNT"
          else
            echo "No results file found"
          fi
      
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: |
            audit_results.csv
            audit_errors.log
          retention-days: 30
      
      - name: Check for issues
        run: |
          if [ -f audit_results.csv ]; then
            LINE_COUNT=$(wc -l < audit_results.csv)
            if [ "$LINE_COUNT" -gt 1 ]; then
              echo "::warning::Audit found $(($LINE_COUNT - 1)) issues in the database"
            else
              echo "No issues found in the audit"
            fi
          fi
      
      - name: Check if database changed
        id: db_check
        run: |
          if git diff --exit-code "$SUCC_DB_PATH" > /dev/null 2>&1; then
            echo "Database unchanged"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Database was modified by audit"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Dump database if changed
        if: steps.db_check.outputs.changed == 'true'
        run: |
          echo "Dumping database to succession_dump.sql..."
          bin/dump_db
      
      - name: Commit database changes
        if: steps.db_check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "$SUCC_DB_PATH" "$SUCC_DUMP_PATH"
          git commit -m "Auto-commit: Update database from audit workflow"
          if ! git push; then
            echo "::error::Failed to push database changes to repository"
            exit 1
          fi
